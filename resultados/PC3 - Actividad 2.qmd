---
title: "Práctica Calificada 3 - Actividad 2"
format: html
editor: visual
---

# **PC 3 - Actividad 2**

## 1. Importación

Se cargan las librerías here y rio. La primera permite manejar las rutas de los archivos dentro del proyecto de forma más ordenada y sin errores al mover carpetas, mientras que la segunda facilita la importación y exportación de datos en distintos formatos como Excel, CSV o SPSS.

```{r}
library(here)
library(rio)
```

```{r}
data_diabetes = import(here("data", "diabetes.csv"))
```

Este código importa el archivo “diabetes.csv” que está dentro de la carpeta “data” del proyecto, usando la ruta gestionada por here(), y guarda ese conjunto de datos en el objeto llamado data_diabetes para poder trabajar con él.

## 2. Limpieza

```{r}
library(tidyverse)
library(janitor)
```

```{r}
names(data_diabetes)
```

Nos muestra los nombres de las columnas o variables que contiene el conjunto de datos data_diabetes, para saber cómo se llaman y qué información incluye cada una.

```{r}
data_diabetes_1 = clean_names(data_diabetes)
```

Se crea una nueva base llamada data_diabetes_1, en la que se limpian y estandarizan los nombres de las variables del conjunto de datos data_diabetes.

```{r}
names(data_diabetes_1)
```

Nos muestra los nombres de las variables del nuevo conjunto de datos data_diabetes_1, para verificar cómo quedaron después de haber sido limpiados y estandarizados.

```{r}
data_diabetes_2 <- rename(data_diabetes_1,
    Núm_Embarazo = num_embarazos,
    Glucosa_2h = glucosa_2h, 
    Presión_Sanguínea = presion_sanguinea, 
    Pliegue_Tríceps = pliegue_triceps, 
    Insulina_2h = insulina_2h, 
    IMC = imc, 
    Historial_Diabetes = historial_diabetes, 
    Edad = edad, 
    Diabetes_5a = diabetes_5a)
```

En la base de datos data_diabetes_2 se cambian los nombres de las variables del conjunto data_diabetes_1 por otros más claros o con mejor formato

```{r}
names(data_diabetes_2)
```

Este código muestra los nombres de las variables del conjunto de datos data_diabetes_2, para confirmar que los cambios de nombre se realizaron correctamente.

```{r}
data_diabetes_3 = mutate_if(data_diabetes_2, is.character, list(~na_if(.,"")))
```

En data_diabetes_3 se reemplaza los valores vacíos (“”) por valores faltantes (NA) en todas las variables que son de tipo texto (character). Esto sirve para que R reconozca correctamente los datos ausentes durante el análisis.

```{r}
data_diabetes_3 |> count(Núm_Embarazo)
data_diabetes_3 |> count(Glucosa_2h)
data_diabetes_3 |> count(Presión_Sanguínea)
data_diabetes_3 |> count(Pliegue_Tríceps)
data_diabetes_3 |> count(Insulina_2h)
data_diabetes_3 |> count(IMC)
data_diabetes_3 |> count(Historial_Diabetes)
data_diabetes_3 |> count(Edad)
data_diabetes_3 |> count(Diabetes_5a)
```

Estos comandos cuentan cuántas veces aparece cada valor en cada una de las variables del conjunto de datos data_diabetes_3 (por ejemplo, en Núm_Embarazo, Glucosa_2h, IMC, etc.).

#Corrección de variables

```{r}
data_diabetes_4 = data_diabetes_3 |>
  mutate(
    Diabetes_5a =
      case_when(
        Diabetes_5a == "negativo" ~ "Negativo",
        Diabetes_5a == "positivo" ~ "Positivo",
        TRUE ~ Diabetes_5a))
```

Se corrigen y uniformizan los valores de la variable Diabetes_5a: cambia las palabras “negativo” y “positivo” para que comiencen con mayúscula (“Negativo” y “Positivo”).

```{r}
data_diabetes_5 <- data_diabetes_4 %>%
  mutate(
    IMC_cat = case_when(
      IMC < 18.5 ~ "Bajo peso",
      IMC >= 18.5 & IMC < 25 ~ "Normal",
      IMC >= 25 & IMC < 30 ~ "Sobrepeso",
      IMC >= 30 & IMC < 35 ~ "Obesidad I",
      IMC >= 35 & IMC < 40 ~ "Obesidad II",
      IMC >= 40 ~ "Obesidad III",
      TRUE ~ NA_character_
    )
  ) %>%
  mutate(IMC_cat = factor(IMC_cat, 
                          levels = c("Bajo peso", "Normal", "Sobrepeso", 
                                     "Obesidad I", "Obesidad II", "Obesidad III")))
```

Se genera una nueva variable llamada IMC_cat (categoría del IMC). Esta variable clasifica a cada persona según su índice de masa corporal (IMC) en seis grupos: Bajo peso, Normal, Sobrepeso, Obesidad I, Obesidad II y Obesidad III. Luego, convierte esa variable en un factor ordenado, para que las categorías sigan un orden lógico al analizar o graficar los datos.

```{r}
data_diabetes_5 |> count(IMC_cat)
```

Este código cuenta cuántas personas hay en cada categoría del IMC (como Bajo peso, Normal, Sobrepeso, Obesidad I, etc.) dentro del conjunto de datos data_diabetes_5.

#Colapso de variables

```{r}
data_diabetes_6 <- data_diabetes_5 %>%
  mutate(
    Grupo_etario = case_when(
      Edad >= 18 & Edad <= 29 ~ "18-29",
      Edad >= 30 & Edad <= 39 ~ "30-39",
      Edad >= 40 & Edad <= 49 ~ "40-49",
      Edad >= 50 & Edad <= 59 ~ "50-59",
      Edad >= 60             ~ "60+",
      TRUE ~ NA_character_
    )
  ) %>%
  mutate(Grupo_etario = factor(Grupo_etario, 
                             levels = c("18-29", "30-39", "40-49", "50-59", "60+")))
```

Se añade la variable Grupo_etario, que clasifica a las personas según su edad en cinco rangos: 18-29, 30-39, 40-49, 50-59 y 60+. Después, convierte esa variable en un factor ordenado para que los grupos de edad mantengan su secuencia correcta al analizar o representar los datos.

```{r}
data_diabetes_6 |> count(Grupo_etario)
```

Este código cuenta cuántas personas hay en cada grupo de edad dentro del conjunto de datos data_diabetes_6.

#Descargamos la base limpia

```{r}
write.csv(data_diabetes_6, "data_diabetes_6.csv", row.names = FALSE)
```

Este código guarda el conjunto de datos data_diabetes_6 en un archivo llamado “data_diabetes_6.csv”, sin incluir los números de fila. Así se crea una copia del archivo final con todas las modificaciones realizadas, lista para compartir o usar en otros programas.

------------------------------------------------------------------------

-   *Se procede a usar el último data como el punto inicial para seguir con los nuevos modelos a trabajar.*

Se importa el archivo “data_diabetes_6.csv” desde la carpeta data del proyecto y lo guarda en un nuevo objeto llamado diabetes, para poder trabajar nuevamente con esa base de datos en RStudio.

```{r}
diabetes = import(here("data", "data_diabetes_6.csv"))
```

## 3. Análisis descriptivo de datos

```{r}
library(skimr)
```

Este código carga la librería skimr, que permite generar resúmenes descriptivos completos y organizados de los datos.

***a. Verificamos el contenido de nuestra estructura***

```{r}
str(diabetes)
```

Se muestra la estructura del conjunto de datos diabetes, indicando cuántas observaciones y variables tiene, los tipos de datos de cada variable (numérico, texto, factor, etc.) y algunos valores de ejemplo.

***b. Estadísticas descriptivos generales por grupo de diabetes***

```{r}
diabetes %>%
  group_by(Diabetes_5a) %>%
  summarise(
    n = n(),
    Edad_prom = mean(Edad, na.rm = TRUE),
    Edad_sd = sd(Edad, na.rm = TRUE),
    Glucosa_prom = mean(Glucosa_2h, na.rm = TRUE),
    Glucosa_sd = sd(Glucosa_2h, na.rm = TRUE),
    IMC_prom = mean(IMC, na.rm = TRUE),
    IMC_sd = sd(IMC, na.rm = TRUE),
    Presion_prom = mean(Presión_Sanguínea, na.rm = TRUE),
    Presion_sd = sd(Presión_Sanguínea, na.rm = TRUE)
  )
```

Este código calcula resúmenes estadísticos del conjunto de datos diabetes, agrupando a las personas según su resultado de Diabetes_5a (Negativo o Positivo). Para cada grupo, muestra: - n: cantidad de personas. - Edad_prom / Edad_sd: promedio y desviación estándar de la edad. - Glucosa_prom / Glucosa_sd: promedio y desviación estándar de la glucosa. - IMC_prom / IMC_sd: promedio y desviación estándar del IMC. - Presion_prom / Presion_sd: promedio y desviación estándar de la presión sanguínea.

***c. Gráficos descriptivos***

```{r}
# Histograma de la glucosa
ggplot(diabetes, aes(x = Glucosa_2h)) +
  geom_histogram(bins = 25, fill = "skyblue", color = "black") +
  labs(title = "Distribución de glucosa a las 2 horas", 
       x = "Glucosa (mg/dL)", 
       y = "Frecuencia") +
  theme_minimal()
```

Se observa que la mayoría tiene valores entre 90 y 130 mg/dL, lo que indica una tendencia central hacia niveles normales de glucosa, aunque también hay algunos casos con valores más altos (mayores de 150 mg/dL), lo que sugiere la presencia de individuos con hiperglucemia. En conjunto, la distribución es asimétrica hacia la derecha, reflejando que hay menos personas con valores muy elevados de glucosa.

```{r}
# Boxplot de glucosa según diagnóstico de diabetes
ggplot(diabetes, aes(x = factor(Diabetes_5a), y = Glucosa_2h, fill = factor(Diabetes_5a))) +
  geom_boxplot() +
  labs(title = "Glucosa según diagnóstico de diabetes a 5 años",
       x = "Diabetes a 5 años (0 = No, 1 = Sí)", 
       y = "Glucosa (mg/dL)") +
  theme_minimal()
```

Se observa que quienes fueron positivos presentan valores de glucosa más altos y una mayor dispersión, mientras que el grupo negativo tiene valores más bajos y concentrados. Esto sugiere una relación directa entre niveles elevados de glucosa y el desarrollo posterior de diabetes, apoyando la idea de que una glucosa alta es un factor de riesgo.

```{r}
# Gráfico de barras por grupo etario
ggplot(diabetes, aes(x = Grupo_etario, fill = factor(Diabetes_5a))) +
  geom_bar(position = "dodge") +
  labs(title = "Distribución de diabetes por grupo etario",
       x = "Grupo etario", 
       y = "Frecuencia", 
       fill = "Diabetes (5 años)") +
  theme_minimal()
```

ENn este gráfico se observa que la mayor cantidad de participantes se concentra en el grupo de 18 a 29 años, donde predominan los casos negativos para diabetes. A medida que aumenta la edad, el número total de personas disminuye, pero la proporción de casos positivos tiende a ser más alta en los grupos mayores (especialmente desde los 40 años). Esto sugiere que la frecuencia de diabetes aumenta con la edad, lo cual es consistente con lo esperado clínicamente.

## 4. Pruebas inferenciales

Objetivo: Evaluar si existen diferencias o asociaciones significativas entre variables en los pacientes con y sin diabetes a 5 años (variable `Diabetes_5a`)

***A. Chi Cuadrado***

*Asociación entre Diabetes_5a y Grupo_etario*

```{r}
tabla1 <- table(diabetes$Diabetes_5a, diabetes$Grupo_etario)
chisq.test(tabla1)
```

*Asociación entre Diabetes_5a y IMC_cat*

```{r}
tabla2 <- table(diabetes$Diabetes_5a, diabetes$IMC_cat)
chisq.test(tabla2)
```

*Asociación entre Diabetes_5a y Historial_Diabetes*

```{r}
tabla3 <- table(diabetes$Diabetes_5a, diabetes$Historial_Diabetes)
chisq.test(tabla3)
```

***B. Comparación de medias***

Objetivo: comparar promedios de variables numéricas (glucosa, edad, IMC, presión) entre los grupos con y sin diabetes.

*T de Student: Edad según diagnóstico*

```{r}
t.test(Edad ~ Diabetes_5a, data = diabetes)
```

*T de Student: Glucosa_2h según diagnóstico*

```{r}
t.test(Glucosa_2h ~ Diabetes_5a, data = diabetes)
```

*T de Student: IMC según diagnóstico*

```{r}
t.test(IMC ~ Diabetes_5a, data = diabetes)
```

*T de Student: Presión_Sanguínea según diagnóstico*

```{r}
t.test(Presión_Sanguínea ~ Diabetes_5a, data = diabetes)
```

## **5. Modelado predictivo/ Método de regresión**

Regresión lineal simple

-   Variable dependiente: Glucosa_2h

-   Variable independiente: Edad

```{r}
# Gráfico de dispersión con línea de tendencia lineal
diabetes |> 
  ggplot(aes(x = Edad, y = Glucosa_2h)) +
  geom_point(color = "skyblue", size = 2) +
  geom_smooth(method = "lm", color = "darkred", se = FALSE) +
  labs(
    x = "Edad (años)",
    y = "Glucosa a las 2 horas (mg/dL)",
    title = "Relación entre Edad y Glucosa (Regresión lineal simple)")
```

Interpretación:

Este gráfico muestra cómo cambia la glucosa a medida que aumenta la edad.\
La línea roja representa la tendencia estimada por la regresión lineal.

```{r}
# Modelo de regresión lineal simple
modelo_lineal <- lm(Glucosa_2h ~ Edad, data = diabetes)
```

```{r}
# Resumen del modelo
summary(modelo_lineal)
```

El valor p \< 0.001 (6.21e-14) indica que la relación entre edad y glucosa es altamente significativa. Es decir, la edad influye de forma significativa en los niveles de glucosa. Además, por cada año adicional de edad, el nivel promedio de glucosa aumenta 0.69 mg/dL, manteniendo las demás condiciones constantes.

**Interpretación:**

-   Se realizó una regresión lineal simple entre la glucosa a las 2 horas (variable dependiente) y la edad (variable independiente). El modelo fue estadísticamente significativo (p \< 0.001), mostrando que por cada año adicional de edad, los niveles de glucosa aumentan en promedio 0.69 mg/dL. Sin embargo, la edad explica solo el 7.1% de la variabilidad en los niveles de glucosa (R² = 0.071), lo que sugiere que otros factores podrían contribuir de manera importante a los valores de glucosa.

## 6. Regresión logística binaria

#Cargamos los paquetes necesarios

```{r}
library(dplyr)
library(broom)
```

El primer paquete se utiliza para manipular y transformar datos de forma sencilla (por ejemplo, filtrar, agrupar o resumir información), mientras que broom sirve para organizar y presentar los resultados de modelos estadísticos en tablas ordenadas y fáciles de interpretar.

#Nos aseguramos que la variable dependiente sea un factor

```{r}
diabetes$Diabetes_5a <- factor(diabetes$Diabetes_5a, levels = c("Negativo", "Positivo"))
```

Este código convierte la variable Diabetes_5a en un factor (una variable categórica) con dos niveles ordenados: primero “Negativo” y luego “Positivo”.

#Ajuste del modelo de regresión logística binaria

```{r}
modelo_logistico <- glm(Diabetes_5a ~ Edad + IMC + Glucosa_2h + Presión_Sanguínea,
                        data = diabetes,
                        family = binomial(link = "logit"))
```

Se analiza cómo las variables Edad, IMC, Glucosa_2h y Presión_Sanguínea influyen en la probabilidad de tener diabetes positiva a 5 años (Diabetes_5a).\

La función `glm()` ajusta el modelo, y el argumento `family = binomial(link = "logit")` indica que se trata de una regresión logística, adecuada para una variable dependiente binaria (*Positivo/Negativo*).

#Resumen del modelo

```{r}
summary(modelo_logistico)
```

El modelo indica que Edad, IMC y Glucosa a las 2 horas son factores significativos que aumentan la probabilidad de desarrollar diabetes a 5 años, mientras que Presión sanguínea no muestra una relación estadísticamente significativa.

#Calculamos los odds ratio

```{r}
exp(cbind(Odds_Ratio = coef(modelo_logistico),
          confint(modelo_logistico)))
```

#Presentación de resultados

```{r}
tidy(modelo_logistico, exponentiate = TRUE, conf.int = TRUE)
```

Los resultados muestran que Edad, IMC y Glucosa a las 2 horas se asocian significativamente con un mayor riesgo de diabetes. A medida que aumentan estas variables, también se incrementa la probabilidad de presentar un resultado positivo. En cambio, Presión sanguínea no mostró una relación significativa con la diabetes a 5 años.

#### **Cargamos las librerías**

```{r}
library(tidyverse)
library(skimr)
library(janitor)
library(gtsummary)
```

#### Convertimos variables categóricas a factor

```{r}
diabetes <- diabetes %>%
  mutate(
    Diabetes_5a = as.factor(Diabetes_5a),
    IMC_cat = as.factor(IMC_cat),
    Grupo_etario = as.factor(Grupo_etario)
  )
```

## 7. Análisis univariado

**Numéricas**

```{r}
skim(diabetes %>% select(`Glucosa_2h`, `Presión_Sanguínea`, `Pliegue_Tríceps`,
                         `Insulina_2h`, `IMC`, `Historial_Diabetes`, `Edad`))
```

La gráfica del resumen univariado muestra cómo se distribuyen las variables numéricas del estudio. En general, se observa que la mayoría de variables presentan una distribución asimétrica hacia valores altos, especialmente Glucosa, Insulina y Pliegue Tríceps, que muestran colas derechas pronunciadas. Además, algunas variables tienen valores faltantes importantes, como Insulina y Pliegue Tríceps, lo cual se refleja en sus porcentajes de completitud más bajos.\

En contraste, variables como **IMC, Edad y Presión Arterial** tienen distribuciones más centradas y con menos dispersión. En conjunto, el gráfico permite apreciar la variabilidad de cada indicador y resalta qué variables podrían requerir un tratamiento especial por su asimetría o número de datos faltantes.

**Categóricas**

```{r}
diabetes %>% 
  select(`Diabetes_5a`, `IMC_cat`, `Grupo_etario`) %>%
  map(table)
```

En la variable **Diabetes_5a**, la mayoría de participantes obtuvo un resultado Negativo (500 casos), mientras que 268 fueron Positivos, mostrando que el grupo sin diabetes es más numeroso.

Respecto a **IMC_cat**, la mayor parte de la muestra se concentra en categorías de sobrepeso y obesidad, especialmente en Obesidad I (224 casos) y Sobrepeso (179). Las categorías extremas como Bajo peso son poco frecuentes.

En cuanto a **Grupo_etario**, predomina claramente la población joven de 18 a 29 años (396 casos), seguida por los grupos de 30–39 y 40–49. Los adultos mayores de 60+ representan el grupo menos numeroso.

## 8. Regresión univariada

Usamos como ejemplo la variable Glucosa_2h

```{r}
modelo_uni <- glm(`Diabetes_5a` ~ `Glucosa_2h`,
                   data = diabetes, family = binomial)
```

```{r}
summary(modelo_uni)
```

El modelo evalúa la asociación entre los niveles de Glucosa a las 2 horas y la probabilidad de presentar un resultado positivo en la variable *Diabetes_5a*. Los resultados muestran que Glucosa_2h es un predictor significativo del diagnóstico.

El coeficiente obtenido para Glucosa_2h es 0.0406 y presenta un valor p \< 0.001, lo que indica una asociación estadísticamente significativa. Esto significa que por cada aumento de 1 mg/dL en la glucosa poscarga, la razón de momios (odds) de tener diabetes aumenta de forma constante. Al exponenciar este coeficiente se obtiene un OR ≈ 1.04, es decir, un incremento del 4% en los odds de diabetes por cada mg/dL adicional de glucosa.

El intercepto negativo (–5.71) refleja que, cuando la glucosa es muy baja, la probabilidad basal de diabetes es igualmente muy baja.

Además, la reducción del deviance (de 986.70 a 786.56) y el AIC de 790.56 indican que el modelo con Glucosa_2h explica la variabilidad del diagnóstico mejor que un modelo sin predictores.

En conjunto, estos resultados muestran que mayores valores de Glucosa_2h están fuertemente asociados con un mayor riesgo de diabetes, confirmando su relevancia clínica como predictor temprano del estado metabólico.

## 9. Regresión multivariada

```{r}
modelo_multi <- glm(`Diabetes_5a` ~ `Glucosa_2h` + `IMC` + `Historial_Diabetes` +
                      `Edad` + `IMC_cat` + `Grupo_etario`,
                    data = diabetes, family = binomial)
```

```{r}
summary(modelo_multi)
```

Este modelo evalúa simultáneamente el efecto de varias variables sobre la probabilidad de presentar un resultado positivo en *Diabetes_5a*.

Los resultados muestran que, una vez controlados los demás factores del modelo, solo tres variables mantienen una asociación estadísticamente significativa:

**Glucosa_2h (p \< 0.001)**

El coeficiente positivo (0.0364) indica que a mayor glucosa poscarga, mayor es la probabilidad de presentar diabetes. Exponenciado, su OR ≈ 1.037, lo que significa que por cada 1 mg/dL adicional, los *odds* de diabetes aumentan 3.7%, incluso ajustando por IMC, edad y otros factores. Esto confirma que la glucosa poscarga es el predictor más fuerte e independiente del modelo.

**IMC (p = 0.0117)**

El IMC también es un predictor significativo en el modelo. Su coeficiente (0.1207) indica que a mayor IMC, mayor es la probabilidad de diabetes, con un OR aproximado de 1.13. Esto implica que cada unidad adicional de IMC incrementa los odds de diabetes en alrededor de 13%, independiente de la glucosa y otros factores clínicos.

**Historial_Diabetes (p = 0.0039)**

El historial previo de diabetes muestra un efecto significativo y positivo (coef 0.90), con un OR cercano a 2.46, lo que significa que las personas con mayor historial o antecedentes tienen más del doble de probabilidad de presentar un resultado positivo. Este hallazgo es coherente desde el punto de vista clínico.

*Conclusión:*

A pesar de incluirlas en el modelo, no mostraron asociación independiente:

-    **Edad**

-    **IMC_cat** (todas sus categorías)

-    **Grupo_etario** (todas las categorías)

En estos casos, los valores p altos indican que no aportan evidencia de efecto propio cuando la glucosa, el IMC continuo y el historial ya están en el modelo.\
Esto sugiere que parte del efecto de edad y IMC categórico queda absorbido por variables más informativas (como IMC continuo y glucosa).

